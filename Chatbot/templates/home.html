{% include 'layout.html'%}
<div class="container">
    <div>
        <div class="card text-center mt-3">
            <div class="card-body chat-history" id="chatHistory" style="height: 400px; overflow: hidden;overflow-y: auto;">
                {% for response in chat_response %}
                <div class="{{ 'chat-message user-input' if loop.index0 is even else 'chat-message ai-response' }}">
                    {{ response | safe}}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="container" id="inputColumn">
      <!-- Image Preview -->
      <div id="imagePreviewContainer" style="margin-top: 10px; text-align: center;"></div>

      <div class="input-group mb-3">
          <button class="btn btn-outline-primary" type="button" id="plusButton">
            <img src="./static/img/attach.png" alt="Attach" style="width: 16px; height: 16px;">
          </button>
          <textarea class="form-control" placeholder="What can i do for you today?" id="userInput" oninput="autoResize(this)"></textarea>
          <button class="btn btn-outline-primary" type="button" id="sendButton">Send</button>
      </div>
        
    </div>

    <input type="file" id="imageUpload" accept="image/*" style="display:none;">
</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    var ws = new WebSocket("ws://localhost:8000/ws");
    var sendButton = document.getElementById("sendButton");
    var plusButton = document.getElementById("plusButton");
    var userInput = document.getElementById("userInput");
    var chatHistory = document.getElementById("chatHistory");
    var imagePreviewContainer = document.getElementById("imagePreviewContainer");
    var lastUserMessageDiv = null;
    var isNewUserInput = true;

    let selectedImageFile = null;
    let typingMessageDiv = null;

    // window.addEventListener('load', loadChatHistory);

    // Update connection status on open, close, or error
    ws.onopen = function() {
      console.log("Websocket connection established.");
      sendButton.disabled = false;
    }

    ws.onclose = function() {
      console.log("Websocket connection closed.");
      sendButton.disabled = true;
    }

    async function saveMessageToServer(message, type) {
      try {
        const response = await fetch('/chat/save', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            session_id: sessionId, 
            message_type: type,
            content: message
          })
        });
        return await response.json();
      } catch (error) {
        console.error('Error saving message to server:', error);
      }
    }

    async function loadChatHistoryFromServer() {
      try {
        const response = await fetch(`/chat/history/${sessionId}`);
        const data = await response.json();

        chatHistory.innerHTML = '';

        data.messages.forEach(message => {
          const messageDiv = document.createElement('div');
          messageDiv.className = `chat-message ${message.message_type === 'user' ? 'user-input' : 'ai-response'}`;
          messageDiv.innerHTML = message.content;
          chatHistory.appendChild(messageDiv);
        });

        chatHistory.scrollTop = chatHistory.scrollHeight;
      } catch (error) {
        console.error('Error loading chat history:', error);
      }
    }

    const sessionId = localStorage.getItem('chatSessionId') || Date.now().toString(36) + Math.random().toString(36).substr(2);
    localStorage.setItem('chatSessionId', sessionId);

    console.log("Session ID:", sessionId);

    window.addEventListener('load', loadChatHistoryFromServer);

    ws.onmessage = async function(event) {
      if (typingMessageDiv) {
        typingMessageDiv.remove();
        typingMessageDiv = null;
      }

      var message = event.data.trim();
      console.log("Raw WebSocket message received:", message);

      const messageParts = message.split("|");
      if (messageParts.length > 1) {
        message = messageParts.slice(1).join("|");
      }
      console.log("Processed message: ", message);

      if (lastUserMessageDiv && !isNewUserInput){
          var shouldAddSpace = true;
          var noPrependSpaceChars = [',', '.', '!', '?', ';', ':', "'"];

          if (noPrependSpaceChars.includes(message.charAt(0))) {
              shouldAddSpace = false;
          }

          lastUserMessageDiv.innerHTML += (shouldAddSpace ? " " : "") + message;
          await saveMessageToServer(lastUserMessageDiv.innerHTML, 'user');
      } else {
        var messageDiv = document.createElement("div");
        messageDiv.className = "chat-message ai-response";
        messageDiv.innerHTML = message;
        chatHistory.appendChild(messageDiv);

        await saveMessageToServer(message, 'assistant');

        chatHistory.scrollTop = chatHistory.scrollHeight;

        isNewUserInput = true;
      }

      console.log("Received message: ", event.data);
    };

    ws.onerror = function(error) {
      console.log("Websocket error:", error);
      sendButton.disabled = true;
    }

    function autoResize(textarea) {
      textarea.style.height = 'auto';
      textarea.style.height = textarea.scrollHeight + 'px';
    }

    plusButton.onclick = function() {
        document.getElementById("imageUpload").click();
    };

    const imageUpload = document.getElementById('imageUpload');
    // const imagePreviewContainer = document.getElementById('imagePreviewContainer');

    document.getElementById("imageUpload").onchange = function(event)  {
      const file = event.target.files[0]
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          imagePreviewContainer.innerHTML = `<img src="${e.target.result}" alt="Image Preview" style="max-width: 100px">`;
          
        };

        reader.readAsDataURL(file);
        selectedImageFile = file;
      }
    }; 

    userInput.addEventListener('keypress', function(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendButton.click();
      }
    });

    sendButton.onclick = async function() {
      if (ws.readyState !== WebSocket.OPEN) {
        alert("Connection to server lost. Please refresh the page.");
        return;
      }

      const userMessage = userInput.value.trim();
      const formData = new FormData();

      ws.send(`${sessionId}|${userMessage}`);
      console.log("Sending message: ", `${sessionId}|${userMessage}`);

      if (!userMessage && !selectedImageFile) {
        alert("Please enter a message or select an image.");
        return;
      }

      try {
        if (userMessage) {
          formData.append('user_input', userMessage);
        }

        if (selectedImageFile) {
          formData.append('file', selectedImageFile);
        }

        const response = await fetch ('/upload/', {
          method: 'POST',
          body: formData
        });

        const data = await response.json();

        if (data.success) {
          if (data.file_url) {
            const imageMessageDiv = document.createElement("div");
            imageMessageDiv.className = "chat-message user-input";
            imageMessageDiv.innerHTML = `<img src="${data.file_url}" alt="Uploaded Image" style="max-width: 50px">`;
            chatHistory.appendChild(imageMessageDiv);
            ws.send(`${sessionId}|${data.file_url}`);
          }
          if (userMessage) {
            const userInputDiv = document.createElement("div");
            userInputDiv.className = "chat-message user-input";
            userInputDiv.textContent = userMessage;
            chatHistory.appendChild(userInputDiv);
            lastUserMessageDiv = userInputDiv;
          }
          if (typingMessageDiv) {
            typingMessageDiv.remove();
          }
          typingMessageDiv = document.createElement("div");
          typingMessageDiv.className = "chat-message ai-response";
          typingMessageDiv.innerHTML = "Typing...";
          chatHistory.appendChild(typingMessageDiv);

          // Clear input and reset state
          userInput.value = '';
          autoResize(userInput);
          selectedImageFile = null;
          imagePreviewContainer.innerHTML = "";
          chatHistory.scrollTop = chatHistory.scrollHeight;
          isNewUserInput = true;
        } else {
          throw new Error(data.error || "Upload failed");
        }
      } catch (error) {
        console.error("Error sending message: ", error);
        alert("Failed to send message. Please try again.")
      }
    };
</script>